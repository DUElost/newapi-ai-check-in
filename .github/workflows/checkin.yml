name: newapi.ai è‡ªåŠ¨ç­¾åˆ°
on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:
    inputs:
      accounts:
        description: 'è´¦å·é…ç½® (JSON æ ¼å¼ï¼Œå¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨ secrets.ACCOUNTS)'
        required: false
        type: string
        default: ''
      providers:
        description: 'è‡ªå®šä¹‰ Provider é…ç½® (JSON æ ¼å¼ï¼Œå¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨ secrets.PROVIDERS)'
        required: false
        type: string
        default: ''
      debug:
        description: 'è°ƒè¯•æ¨¡å¼ (å¯ç”¨åä¼šä¿å­˜æˆªå›¾å’Œ HTML æ—¥å¿—)'
        required: false
        type: boolean

jobs:
  checkin:
    permissions:
      id-token: write
      contents: read
    runs-on: windows-2025
    environment: production
    env:
      PYTHONIOENCODING: utf-8
    steps:
    - name: set beijing timezone
      uses: szenius/set-timezone@v2.0
      with:
        timezoneWindows: "China Standard Time"

    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ç¼“å­˜ UV ä¾èµ–
      uses: actions/cache@v4
      id: uv-cache
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: å®‰è£…ä¾èµ–
      if: steps.uv-cache.outputs.cache-hit != 'true'
      run: |
        echo "ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
        uv sync
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: è·å– Camoufox ç‰ˆæœ¬
      id: camoufox-version
      run: |
        $version = uv run python -c "import importlib.metadata; print(importlib.metadata.version('camoufox'))"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Camoufox version: $version"

    - name: ç¼“å­˜ Camoufox æµè§ˆå™¨
      uses: actions/cache@v4
      id: camoufox-cache
      with:
        path: ~\AppData\Local\camoufox
        key: ${{ runner.os }}-camoufox-${{ steps.camoufox-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-camoufox-

    - name: å®‰è£… Camoufox æµè§ˆå™¨
      if: steps.camoufox-cache.outputs.cache-hit != 'true'
      run: |
        echo "ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹ä¸‹è½½ Camoufox æµè§ˆå™¨..."
        uv run camoufox fetch
        echo "âœ… Camoufox æµè§ˆå™¨å®‰è£…å®Œæˆ"

    - name: æ¢å¤ç™»å½•çŠ¶æ€ç¼“å­˜
      uses: actions/cache/restore@v4
      with:
        path: |
          storage-states
        key: storage-state-${{ hashFiles('storage-states/*.json') }}
        restore-keys: |
          storage-state-

    - name: æ¢å¤ä½™é¢å†å²ç¼“å­˜
      uses: actions/cache/restore@v4
      with:
        path: |
          balance_hash.txt
        key: balance-hash-${{ hashFiles('balance_hash.txt') }}
        restore-keys: |
          balance-hash-

    - name: æ ¡éªŒè´¦å·é…ç½® JSON
      env:
        ACCOUNTS: ${{ inputs.accounts || secrets.ACCOUNTS }}
        ACCOUNTS_LINUX_DO: ${{ secrets.ACCOUNTS_LINUX_DO }}
        ACCOUNTS_GITHUB: ${{ secrets.ACCOUNTS_GITHUB }}
        PROVIDERS: ${{ inputs.providers || secrets.PROVIDERS }}
        PROXY: ${{ secrets.PROXY }}
      run: |
        function Test-JsonType {
          param(
            [Parameter(Mandatory = $true)]
            [string]$Name,
            [Parameter(Mandatory = $true)]
            [string]$ExpectedType,
            [bool]$Required = $false
          )

          $value = [Environment]::GetEnvironmentVariable($Name)
          if ([string]::IsNullOrWhiteSpace($value)) {
            if ($Required) {
              Write-Host "::error::$Name æœªé…ç½®ï¼Œè¯·åœ¨ production ç¯å¢ƒ Secret ä¸­è®¾ç½®"
              exit 1
            }
            Write-Host "â„¹ï¸ $Name æœªé…ç½®ï¼Œè·³è¿‡æ ¡éªŒ"
            return $null
          }

          try {
            $parsed = $value | ConvertFrom-Json -Depth 100
          } catch {
            Write-Host "::error::$Name ä¸æ˜¯åˆæ³• JSON: $($_.Exception.Message)"
            exit 1
          }

          if ($ExpectedType -eq "array" -and -not ($parsed -is [System.Array])) {
            Write-Host "::error::$Name å¿…é¡»æ˜¯ JSON æ•°ç»„æ ¼å¼ []"
            exit 1
          }
          if ($ExpectedType -eq "object" -and ($parsed -is [System.Array] -or $null -eq $parsed)) {
            Write-Host "::error::$Name å¿…é¡»æ˜¯ JSON å¯¹è±¡æ ¼å¼ {}"
            exit 1
          }

          Write-Host "âœ… $Name JSON æ ¼å¼æ ¡éªŒé€šè¿‡"
          return $parsed
        }

        function Has-Property {
          param(
            [Parameter(Mandatory = $true)]$Obj,
            [Parameter(Mandatory = $true)][string]$Name
          )
          return $null -ne $Obj.PSObject.Properties[$Name]
        }

        $accounts = Test-JsonType -Name "ACCOUNTS" -ExpectedType "array" -Required $true
        if ($accounts.Count -eq 0) {
          Write-Host "::error::ACCOUNTS ä¸èƒ½ä¸ºç©ºæ•°ç»„ï¼Œè‡³å°‘éœ€è¦ä¸€ä¸ªè´¦å·"
          exit 1
        }

        for ($i = 0; $i -lt $accounts.Count; $i++) {
          $account = $accounts[$i]
          if ($null -eq $account.PSObject) {
            Write-Host "::error::ACCOUNTS[$i] å¿…é¡»æ˜¯ JSON å¯¹è±¡"
            exit 1
          }

          $hasCookies = Has-Property -Obj $account -Name "cookies"
          $hasLinuxDo = Has-Property -Obj $account -Name "linux.do"
          $hasGithub = Has-Property -Obj $account -Name "github"

          if (-not ($hasCookies -or $hasLinuxDo -or $hasGithub)) {
            Write-Host "::error::ACCOUNTS[$i] å¿…é¡»åŒ…å« cookies / linux.do / github å…¶ä¸­ä¹‹ä¸€"
            exit 1
          }

          if ($hasCookies -and -not (Has-Property -Obj $account -Name "api_user")) {
            Write-Host "::error::ACCOUNTS[$i] ä½¿ç”¨ cookies æ—¶å¿…é¡»é…ç½® api_user"
            exit 1
          }
        }

        $linuxDoAccounts = Test-JsonType -Name "ACCOUNTS_LINUX_DO" -ExpectedType "array"
        if ($linuxDoAccounts) {
          for ($i = 0; $i -lt $linuxDoAccounts.Count; $i++) {
            $item = $linuxDoAccounts[$i]
            if (-not (Has-Property -Obj $item -Name "username") -or -not (Has-Property -Obj $item -Name "password")) {
              Write-Host "::error::ACCOUNTS_LINUX_DO[$i] å¿…é¡»åŒ…å« username å’Œ password"
              exit 1
            }
          }
        }

        $githubAccounts = Test-JsonType -Name "ACCOUNTS_GITHUB" -ExpectedType "array"
        if ($githubAccounts) {
          for ($i = 0; $i -lt $githubAccounts.Count; $i++) {
            $item = $githubAccounts[$i]
            if (-not (Has-Property -Obj $item -Name "username") -or -not (Has-Property -Obj $item -Name "password")) {
              Write-Host "::error::ACCOUNTS_GITHUB[$i] å¿…é¡»åŒ…å« username å’Œ password"
              exit 1
            }
          }
        }

        Test-JsonType -Name "PROVIDERS" -ExpectedType "object" | Out-Null

        $proxyValue = [Environment]::GetEnvironmentVariable("PROXY")
        if ([string]::IsNullOrWhiteSpace($proxyValue)) {
          Write-Host "â„¹ï¸ PROXY æœªé…ç½®ï¼Œè·³è¿‡æ ¡éªŒ"
        } else {
          try {
            $proxyObj = $proxyValue | ConvertFrom-Json -Depth 100
            if ($proxyObj -is [System.Array] -or $null -eq $proxyObj) {
              Write-Host "::error::PROXY ä¸º JSON æ—¶å¿…é¡»æ˜¯å¯¹è±¡æ ¼å¼ {}"
              exit 1
            }
            Write-Host "âœ… PROXY JSON å¯¹è±¡æ ¼å¼æ ¡éªŒé€šè¿‡"
          } catch {
            # å…¼å®¹é¡¹ç›®åŸæœ‰è¡Œä¸ºï¼šPROXY å¯ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ä»£ç†åœ°å€
            Write-Host "â„¹ï¸ PROXY ä¸æ˜¯ JSONï¼Œå°†æŒ‰çº¯å­—ç¬¦ä¸²ä»£ç†åœ°å€ä½¿ç”¨"
          }
        }

    - name: è´¦å·é…ç½®é¢„è§ˆï¼ˆè„±æ•ï¼‰
      env:
        ACCOUNTS: ${{ inputs.accounts || secrets.ACCOUNTS }}
        ACCOUNTS_LINUX_DO: ${{ secrets.ACCOUNTS_LINUX_DO }}
        ACCOUNTS_GITHUB: ${{ secrets.ACCOUNTS_GITHUB }}
        PROVIDERS: ${{ inputs.providers || secrets.PROVIDERS }}
        PROXY: ${{ secrets.PROXY }}
      run: |
        function Parse-JsonOrNull {
          param(
            [Parameter(Mandatory = $true)]
            [string]$Name
          )

          $value = [Environment]::GetEnvironmentVariable($Name)
          if ([string]::IsNullOrWhiteSpace($value)) {
            return $null
          }

          try {
            return $value | ConvertFrom-Json -Depth 100
          } catch {
            Write-Host "â„¹ï¸ $Name æ— æ³•è§£æä¸º JSONï¼Œé¢„è§ˆæ—¶è·³è¿‡"
            return $null
          }
        }

        function Has-Property {
          param(
            [Parameter(Mandatory = $true)]$Obj,
            [Parameter(Mandatory = $true)][string]$Name
          )
          return $null -ne $Obj.PSObject.Properties[$Name]
        }

        $accounts = Parse-JsonOrNull -Name "ACCOUNTS"
        if ($null -eq $accounts -or -not ($accounts -is [System.Array])) {
          Write-Host "â„¹ï¸ ACCOUNTS ä¸å¯é¢„è§ˆ"
          exit 0
        }

        Write-Host "ğŸ“Š è„±æ•é¢„è§ˆæ‘˜è¦:"
        Write-Host "  - ACCOUNTS æ€»æ•°: $($accounts.Count)"

        for ($i = 0; $i -lt $accounts.Count; $i++) {
          $account = $accounts[$i]
          $displayName = if ((Has-Property -Obj $account -Name "name") -and -not [string]::IsNullOrWhiteSpace($account.name)) { $account.name } else { "Account $($i + 1)" }
          $provider = if ((Has-Property -Obj $account -Name "provider") -and -not [string]::IsNullOrWhiteSpace($account.provider)) { $account.provider } else { "anyrouter" }
          $hasCookies = Has-Property -Obj $account -Name "cookies"
          $hasApiUser = Has-Property -Obj $account -Name "api_user"
          $hasLinuxDo = Has-Property -Obj $account -Name "linux.do"
          $hasGithub = Has-Property -Obj $account -Name "github"

          Write-Host "  - [$i] name=$displayName, provider=$provider, cookies=$hasCookies, api_user=$hasApiUser, linux.do=$hasLinuxDo, github=$hasGithub"
        }

        $linuxDoAccounts = Parse-JsonOrNull -Name "ACCOUNTS_LINUX_DO"
        if ($linuxDoAccounts -is [System.Array]) {
          Write-Host "  - ACCOUNTS_LINUX_DO æ€»æ•°: $($linuxDoAccounts.Count)"
        } else {
          Write-Host "  - ACCOUNTS_LINUX_DO: æœªé…ç½®"
        }

        $githubAccounts = Parse-JsonOrNull -Name "ACCOUNTS_GITHUB"
        if ($githubAccounts -is [System.Array]) {
          Write-Host "  - ACCOUNTS_GITHUB æ€»æ•°: $($githubAccounts.Count)"
        } else {
          Write-Host "  - ACCOUNTS_GITHUB: æœªé…ç½®"
        }

        $providers = Parse-JsonOrNull -Name "PROVIDERS"
        if ($null -ne $providers -and -not ($providers -is [System.Array])) {
          Write-Host "  - PROVIDERS è‡ªå®šä¹‰æ•°é‡: $($providers.PSObject.Properties.Count)"
        } else {
          Write-Host "  - PROVIDERS: æœªé…ç½®"
        }

        $proxy = [Environment]::GetEnvironmentVariable("PROXY")
        if ([string]::IsNullOrWhiteSpace($proxy)) {
          Write-Host "  - PROXY: æœªé…ç½®"
        } else {
          try {
            $proxyObj = $proxy | ConvertFrom-Json -Depth 100
            if ($proxyObj -is [System.Array] -or $null -eq $proxyObj) {
              Write-Host "  - PROXY: å·²é…ç½®ï¼ˆç±»å‹å¼‚å¸¸ï¼‰"
            } else {
              $proxyServer = if ($null -ne $proxyObj.PSObject.Properties["server"] -and -not [string]::IsNullOrWhiteSpace($proxyObj.server)) { "å·²è®¾ç½® server" } else { "æ—  server å­—æ®µ" }
              Write-Host "  - PROXY: å·²é…ç½®ï¼ˆJSON å¯¹è±¡, $proxyServerï¼‰"
            }
          } catch {
            Write-Host "  - PROXY: å·²é…ç½®ï¼ˆå­—ç¬¦ä¸²ï¼‰"
          }
        }
             
    - name: æ‰§è¡Œç­¾åˆ°
      env:
        ACCOUNTS: ${{ inputs.accounts || secrets.ACCOUNTS }}
        ACCOUNTS_LINUX_DO: ${{ secrets.ACCOUNTS_LINUX_DO }}
        ACCOUNTS_GITHUB: ${{ secrets.ACCOUNTS_GITHUB }}
        PROVIDERS: ${{ inputs.providers || secrets.PROVIDERS }}
        PROXY: ${{secrets.PROXY}}
        DEBUG: ${{ github.event_name == 'workflow_dispatch' && inputs.debug || vars.DEBUG || 'false' }}
        DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # åˆ—å‡º storage-states ç›®å½•æ–‡ä»¶
        if (Test-Path "storage-states") {
          echo "ğŸ“ storage-states ç›®å½•å†…å®¹:"
          echo "ç»å¯¹è·¯å¾„: $(Resolve-Path storage-states)"
          echo ""
          echo "æ‰€æœ‰æ–‡ä»¶:"
          Get-ChildItem -Path storage-states -File | ForEach-Object { echo "  - $($_.Name)" }
          echo ""
          echo "è¯¦ç»†ä¿¡æ¯:"
          Get-ChildItem -Path storage-states -File | Format-Table Name, Length, LastWriteTime -AutoSize
          echo "æ–‡ä»¶æ€»æ•°: $((Get-ChildItem -Path storage-states -File).Count)"
        } else {
          echo "âš ï¸ storage-states ç›®å½•ä¸å­˜åœ¨"
        }
        # æ‰§è¡Œç­¾åˆ°
        uv run python -u main.py

    - name: ä¿å­˜ç™»å½•çŠ¶æ€ç¼“å­˜
      if: hashFiles('storage-states/*.json') != ''
      uses: actions/cache/save@v4
      with:
        path: |
          storage-states
        key: storage-state-${{ hashFiles('storage-states/*.json') }}

    - name: ä¿å­˜ä½™é¢å†å²ç¼“å­˜
      if: hashFiles('balance_hash.txt') != ''
      uses: actions/cache/save@v4
      with:
        path: |
          balance_hash.txt
        key: balance-hash-${{ hashFiles('balance_hash.txt') }}

    - name: ä¿å­˜æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: artifacts-${{ github.run_number }}
        path: |
          logs/
          screenshots/
        if-no-files-found: ignore
        retention-days: 7

    - name: æ‰§è¡Œç»“æœ
      if: always()
      run: |
        echo "ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
        echo "æ—¶é—´: $(Get-Date)"
